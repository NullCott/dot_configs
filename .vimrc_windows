set tabstop=4
set shiftwidth=4
set expandtab
set number
set ruler

set showmatch
set ignorecase 
set incsearch
syntax on

function! PasteImageFromClipboard()
  " carpeta destino unix
  let l:dir_unix = expand('%:p:h') . '/img'
  if !isdirectory(l:dir_unix)
    call mkdir(l:dir_unix, 'p')
  endif

  let l:fname = 'img_' . strftime("%Y%m%d_%H%M%S") . '.png'
  let l:full_unix = l:dir_unix . '/' . l:fname

  " convertir /c/... a C:/... y luego a backslashes dobles para PowerShell
  if l:full_unix =~# '^/[A-Za-z]/'
    let l:drive = toupper(strpart(l:full_unix, 1, 1))
    let l:rest  = strpart(l:full_unix, 2)
    let l:win_path = l:drive . ':' . l:rest
  else
    let l:win_path = l:full_unix
  endif
  let l:win_path = substitute(l:win_path, '/', '\\\\', 'g')

  " crear directorio en espacio Windows
  let l:win_dir = fnamemodify(l:win_path, ':h')
  let l:mkcmd_inner = 'New-Item -ItemType Directory -Force -Path "' . l:win_dir . '" | Out-Null'
  call system('powershell.exe -NoProfile -Command ' . shellescape(l:mkcmd_inner))

  " ejecutar PowerShell y capturar salida (stdout+stderr)
  let l:ps_inner = '$img = Get-Clipboard -Format Image; if ($img -ne $null) { $img.Save("' . l:win_path . '"); Write-Output "SAVED" } else { Write-Output "NO_IMAGE" }'
  let l:cmd = 'powershell.exe -NoProfile -Command ' . shellescape(l:ps_inner) . ' 2>&1'
  let l:out_lines = systemlist(l:cmd)
  let l:rc = v:shell_error

  " unir salida y limpiar CR (por si hay ^M)
  let l:out = join(l:out_lines, "\n")
  let l:out = substitute(l:out, '\r', '', 'g')

  " Depuración mínima en :messages
  echom 'DEBUG: rc=' . string(l:rc) . ' out=' . l:out

  if l:rc != 0
    echohl ErrorMsg
    echom 'PasteImageFromClipboard: PowerShell devolvió código de error: ' . l:rc
    echom 'Salida: ' . l:out
    echohl None
    return
  endif

  " buscar SAVED de forma robusta (substring)
  if l:out =~? 'SAVED'
    " asegurarnos de que el buffer es modificable
    if &modifiable == 0
      echom 'Buffer no modificable: no se puede insertar la línea.'
      return
    endif

    " preparar la línea markdown
    let l:md_line = '![](img/' . l:fname . ')'

    " insertar justo debajo de la línea actual; si buffer vacío usa 0
    let l:ln = line('.')
    if l:ln < 0
      let l:ln = 0
    endif
    call append(l:ln, l:md_line)

    " mover cursor a la nueva línea
    execute 'normal! j0'
    echom 'Imagen guardada correctamente y Markdown insertado: ' . l:md_line
    return
  elseif l:out =~? 'NO_IMAGE'
    echom 'No se detectó imagen en el portapapeles (NO_IMAGE).'
    return
  else
    echom 'Respuesta inesperada de PowerShell: ' . l:out
    return
  endif
endfunction

" Mapear a F9 (o cámbialo por la tecla que prefieras)
autocmd FileType markdown nmap <buffer><silent> <F9> :call PasteImageFromClipboard()<CR>

